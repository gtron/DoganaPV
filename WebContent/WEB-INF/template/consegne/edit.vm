#set($activeMenu='PARTITARI')
#parse('costanti.vm')
#set($addJs=['/js/jquery.validate/jquery.validate.js','/js/jquery.validate/jquery.metadata.js','/js/jquery.validate/jquery.additional-method.js','/js/jquery.ui/ui.calendar.js','/js/jquery.ui/ui.dimensions.js','/js/jquery.ui/ui.mouse.js','/js/jquery.ui/ui.draggable.js','/js/jquery.ui/ui.draggable.ext.js','/js/jquery.ui/ui.resizable.js','/js/jquery.ui/ui.dialog.js','/js/jquery.tablefilter/jquery.cookies-packed.js','/js/jquery.tablefilter/prototypes-packed.js','/js/jquery.tablefilter/json-packed.js','/js/jquery.tablefilter/jquery.truemouseout-packed.js','/js/jquery.tablefilter/daemachTools-packed.js','/js/jquery.tablefilter/jquery.tableFilter.js','/js/jquery.tablefilter/jquery.tableFilter.columnStyle-packed.js','/js/jquery.tablefilter/pp.js'] )
#set( $addCss = ['/js/jquery.ui/themes/flora/flora.all.css','/style/tablefilter/tableFilter.aggregator.css','/style/tablefilter/tableFilter.css'] )
#parse('header.vm')
<script>
$().ready(function() 
{ try{
// $("#formConsegne").validate(); 
}
catch(e){alert(e.message);}
} 
);
</script>

#set($hasIva = false)
#if($!obj.Iter.Regiva)
#set($hasIva = true)
#end

#set($isReadonly = false )
#if( $obj.Id && $obj.isAperta() || $obj.isChiusa() )
#set($isReadonly = true)
#end

#set($im7=false)
#set($im4=false)
#if($obj.Iter.Regdoganale)
#set($im7=true)
#else
#set($im4=true)
#end


#if( $result )<div id="result">#if( $msg ) $msg #else Modifica effettuata#end</div> #end

<h2>
#if ( $obj && $obj.Id )
Modifica Consegna <small>[id:$obj.Id]</small>
#else
Nuova Consegna 
#end
</h2>
<form action="?" method="post" id="formConsegne">
<input type="hidden" name="cmd" value="edit" /><input type="hidden" name="exec" value="1" />
<input type="hidden" name="id" value="$!obj.Id" /><input type="hidden" name="idConsegna" value="$!obj.Id" />
<input type="hidden" name="codicenc" value="-" /><input type="hidden" name="posizione" value="-" />
<input type="hidden" name="regimedoganale" value="-" />


<div id="dettagli" style="margin:2px 4px;">
Numero Consegna: <input name="numero" size="4" value="$!obj.Numero"  class="{required:true,number:true}"> - 
Numero Partitario : <input name="numpartitario" size="4" class="{required:true,number:true}"
#if($obj.Id) value="$!obj.NumeroPartitario" #else value="$!nextPartitario"#end><br />

Merce : <select name="idmerce" class="{required:true}">
#if($isReadonly)
<option value="$obj.Idmerce">$obj.Merce.Nome</option>
#else
<option value="">- Seleziona -</option>
#foreach( $i in $merci )<option value="$i.Id" #if($obj.Idmerce == $i.Id) selected #end>$i.Nome</option>#end
#end
</select> 
con Iter : <select name="iter" class="{required:true}" id="iter">
#if($isReadonly)
<option value="$obj.Iter.Id">$obj.Iter.Nome</option>
#else
<option value="">- Seleziona -</option>
#foreach( $i in $iters )
#if($i.Id != 3)
<option value="$i.Id" #if($obj.IdIter == $i.Id) selected #end>$i.Nome</option>
#end#end
#end</select><br>


</div>

<table border="0" width="100%" cellspacing="0" cellpadding="3">
<tbody><tr><td>
Peso Polizza (Kg): <input name="pesopolizza" size="8" id="pesopolizza" value="$!tools.Number.format( $!obj.Pesopolizza)" class="{required:true,double:true}"> <input type="checkbox" #if($!obj.PesoFinalePortoCarico) checked #end name="pesofinaleportocarico" id="pesofinaleportocarico" value="true" />
<label for="pesofinaleportocarico">Peso Finale Porto di Carico</label><br>
Tasso di Umidit&aacute; : <input name="tassoumidita" size="8" class="{required:true,number:true}" value="$!tools.Number.format('##0.000000', $!obj.TassoUmidita).replaceAll(',','.')">% <br>
</td>
<td valign="top">

Provenienza : <input name="provenienza" value="$!obj.Provenienza" class="{required:true}"><br>
Origine : <input name="origine" value="$!obj.Origine" class="{required:true}"><br>
Mezzo : <input name="mezzo" value="$!obj.Mezzo" class="{required:true}"><br>
</td>
</tr>
</table><br>

#*
Posizione Doganale : <select name="posizione" class="{required:true}">
<option value="">- Seleziona -</option>
<option value="NAZ" #if($!obj.Posizione.equals('NAZ')) selected #end>Nazionale</option>
<option value="COM" #if($!obj.Posizione.equals('COM')) selected #end>Comunitaria</option>
<option value="EXT" #if($!obj.Posizione.equals('EXT')) selected #end>Extra Comunitaria</option>
<option value="XNZ" #if($!obj.Posizione.equals('XNZ')) selected #end>Nazionalizzata</option>
<option value="ALT" #if($!obj.Posizione.equals('ALT')) selected #end>altro</option>
</select>
<br>
Regime Doganale : <select name="regimedoganale" class="{required:true}">
<option value="">- Seleziona -</option>
<option value="7100" #if($!obj.Regimedoganale.equals('7100')) selected #end>7100</option>
<option value="4500" #if($!obj.Regimedoganale.equals('4500')) selected #end>4500</option>
<option value="4571" #if($!obj.Regimedoganale.equals('4571')) selected #end>4571</option>
<option value="altro" #if($!obj.Regimedoganale.equals('altro')) selected #end>altro</option>
</select>
<br>
Codice Doganale : <select name="codicenc" class="{required:true}">
<option value="">- Seleziona -</option>
<option value="26080000" #if($!obj.Codicenc.equals('26080000')) selected #end>26080000</option>
<option value="26070000" #if($!obj.Codicenc.equals('26070000')) selected #end>26070000</option>
<option value="altro" #if($!obj.Codicenc.equals('altro')) selected #end>altro</option>
</select><br>
<br>
*#


#if( false && $hasIva)
Tasso di Cambio ($/&euro;) : <input name="tassocambio" size="12" value="$!tools.Number.format('##0.000000000', $!obj.TassoCambio).replaceAll(',','.')"><br>

Valuta : <select name="isvalutaeuro">
<option value="0" #if(! $!obj.getIsValutaEuro()) selected #end>Dollari</option>
<option value="true" #if($!obj.getIsValutaEuro()) selected #end>Euro</option>
</select>
- 
Valore di un Kilogrammo di materiale : <input name="valoreunitario" size="12" value="$!tools.Number.format('##0.000000000', $!obj.ValoreUnitario).replaceAll(',','.')" class="{required:true,number:true}" > <input type="button" value="Calcola" onclick="calcolaValoreUnitario(this)" />

##Aggiorna Peso secco dei Movimenti: <input type="checkbox"><br>
<br /><br />
#else
<input type="hidden" name="valoreunitario" value="1" /><input type="hidden" name="isvalutaeuro" value="0" />
<input type="hidden" name="tassocambio" value="1" />
#end

#if ( $obj.Id )#set( $stalliConsegna = $obj.stalli )#end
#if($hasIva && $!stalliConsegna && $!stalliConsegna.size() > 0 )
<br />

##<fieldset><legend></legend>
<table style="border: 1px solid gray;margin:0 auto;">
<thead><tr>
<th>&nbsp;Stalli&nbsp;</th>
<th>&nbsp;Associato&nbsp;</th>
<th>&nbsp;Immesso in LP&nbsp;</th>
<th>&nbsp;Valore Totale &euro;&nbsp;</th>
<th>&nbsp;Valore Totale $&nbsp;</th>
<th>&nbsp;Valore Unitario &euro;&nbsp;</th>
<th>&nbsp;Valore Unitario $&nbsp;</th>
</tr>
#foreach( $s in $stalliConsegna )
#set($sc='')
#set($sc=$obj.getStalloConsegna($s))
<tr #if($velocityCount %2 == 1)class="odd"#end>
<td align="center"> $s.Parco $s.Numero</td>
<td align="center">
#if( $!s.IdConsegnaAttuale == $!obj.Id) SI #else NO #end
</td>
#if($hasIva)
<td align="center">
#if( $!sc.IsInLiberaPratica || $!s.ImmessoInLiberaPratica)
Si #if($isAdmin)<a href=".main?cmd=resetILP&id=$s.Id&idC=$obj.Id&exec=1">(Reset)</a>#end 
#else
No
#end
</td>
#if ( $sc )
<td align="right">$!tools.Number.format('#,##0.00',$!sc.ValoreEuro)</td>
<td align="right">$!tools.Number.format('#,##0.00',$!sc.ValoreDollari)</td>
<td align="right">$!tools.Number.format('#,##0.000000000000',$!sc.ValoreUnitarioEuro)</td>
<td align="right">$!tools.Number.format('#,##0.000000000000',$!sc.ValoreUnitarioDollari)</td>
#else
<td align="center">-</td>
<td align="center">-</td>
#end
#end
</tr> 
#end
</table>
## </fieldset>
#end


#if( $false && $isAdmin && $obj.Id )
#set($parco = "")
#foreach( $s in $stalli ) 
#if($parco != $s.Parco)
#set($parco = $s.Parco)
#if ( $velocityCount > 1)</td><td valign="top">#end
#set($count = 0 )
#end
#set($count = $count + 1 )
<input type="checkbox" value="$s.Id" name="stalli" #if($s.IdConsegnaAttuale == $obj.Id || $s.IdConsegnaPrenotata == $obj.Id) checked #end id="stallo$velocityCount">
<label for="stallo$velocityCount">$parco $count</label>
#if($s.IdConsegnaAttuale == $obj.Id && $s.HasLiberaPratica)<a href=".main?cmd=resetILP&id=$s.Id&idC=$obj.Id&exec=1">[Reset ILP]</a>#end
## #if($s.IdConsegnaAttuale == $obj.Id)<a href=".consegne?id=$s.Id">[Movimenti]</a>#end
<br>

#end
</td>
#end
</tr>

</table><br />

#if ( $obj.isAperta() && ! $obj.isChiusa() )

<br />
<fieldset>
<legend>Stalli associati alla consegna</legend>
Stalli  associati attualmente: 
#set($c=0)
#foreach( $s in $stalli ) #if( $obj.getId().equals( $s.IdConsegnaAttuale ) )
#set($stalliAssociati="$s.IdConsegnaAttuale")
#if ( $c > 0 ), #end
$s
#set($c=$c+1)
#end
#end
#if ( $c < 1 ) Nessuno #end
<br />
#foreach( $s in $stalli ) #if(! $!s.IdConsegnaAttuale)
#set($options="$options<option value='$s.Id'>$s</option>")
#end#end

#if($options )
Associa stallo:
<select name="idNuovoStallo"> 
$options
</select>
<input type="submit" name="associa" value="Associa" />
#else
Non sono disponibili altri stalli liberi da poter associare.
#end
</fieldset>
#end

#if( $param_error ) 

<script type="text/javascript">

var labels = document.getElementsByTagName('label')
alert( '$param_error.ParamName' );
for( i in labels )  {
if( labels[i].htmlFor == '$param_error.ParamName')  {
	alert('Errore nel campo ' + labels[i].innerHTML );
	break ;
}
}

</script>
#end

<script type="text/javascript">

var idConsegna = '$!obj.Id' ;

function getDouble(id){

var field=document.getElementById(id);
if(! field)return 0 ;

var v=field.value ;

if(field.tagName=='TD')v=field.innerHTML;

while(v.indexOf('.')> 0)v=v.replace('.','');

return 1 * v ;
}

function changedIter(select) {
// alert(select.val());
}

function calcolaValoreUnitario(btn) {
var f = btn.form;
var pesoPolizza = getDouble('pesopolizza') ;

var umidita = f.tassoumidita.value  / 100 ;

var valoreTot = prompt('Inserire il valore totale della consegna') ;

if ( valoreTot < 0 ) {
	alert( 'errore ValoreTot: ' + valoreTot );
	return ;
}
else if ( umidita <= 0 ) {
	alert( 'errore umidita: ' + umidita );
	return ;
}
else if ( pesoPolizza <= 0 ) {
	alert( 'errore pesoPolizza: ' + pesoPolizza );
	return ;
}
else {
f.valoreunitario.value = Math.round( 100000 * valoreTot / ( pesoPolizza - ( pesoPolizza * umidita )  ) ) / 100000 ;
}
}

$('document').ready( function() {

popUpCal.regional['it'] = {clearText: 'Svuota', closeText: 'Chiudi',
prevText: '&lt;Prec', nextText: 'Succ&gt;', currentText: 'Oggi',
dayNames: ['Do','Lu','Ma','Me','Gio','Ve','Sa'],
monthNames: ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno',
'Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']};

popUpCal.setDefaults(popUpCal.regional['it']);

$("#dlg_ImportTo").dialog({ width:360,height:140,
buttons:{Importa: function(){importTo(true);} , Annulla : function() { $("#dlg_ImportTo").dialogClose(); } } 
});
$("#dlg_ImportTo").dialogClose();
$("#dlg_OpenC").dialog({ width:520,height:500,
buttons:{Apri: function(){OpenC(true);} ,Annulla : function() { $("#dlg_OpenC").dialogClose(); } } 
});
$("#dlg_OpenC").dialogClose();

jQuery('#dataImport').calendar();
jQuery('#dataOpenC').calendar();
jQuery('#doc_data').calendar();
jQuery('#docPV_data').calendar();

jQuery('#docPV_data').calendar();

jQuery('#iter').change(function(){changedIter(jQuery(this));});

} ) ;

function openDialog( id , dialogId) {
idConsegna = id ;
$(dialogId).dialogOpen();
return false ;
}
function importTo( exec ) {

$("#dlg_ImportTo").dialogClose();
var data = jQuery('#dataImport').attr('value') ;

// var lnk = 
if( data && data != '' ) {
window.location.href = '.main?cmd=import&exec=1&idConsegna=' + idConsegna + '&to=' +  data ;
}

idConsegna = -1 ;
return false ;
}

function OpenC( exec ) {

$("#dlg_OpenC").dialogClose();

var f = document.getElementById('openC');

f.elements['id'].value = idConsegna;

idConsegna = -1 ;
f.submit();

return false ;
}

</script>

<div align="center">

<br>

<input type="submit" value="Salva" id="submit" style="display:none">
</div>
</form>

<div class="commands">
<ul>
#if ( $obj.Id )
<li>
#if($obj.isChiusa())
<a href="?cmd=edit&r=1&id=$obj.Id" onclick="return confirm('Creare una nuova consegna uguale?');">Duplica</a>
#elseif($obj.isAperta())
<a href="?cmd=chiudi&id=$obj.Id&exec=1" onclick="return confirm('Chiudere la consegna selezionata?');"><img src="$!images/action-ico-elimina.png" />Chiudi</a>
#else
<a href="#" x="?cmd=apri&id=$obj.Id&exec=1" onclick="openDialog($obj.Id,'#dlg_OpenC');return false;"><img src="$!images/action-ico-apri.png" />Apri</a>
#end
</li>
#end

<li><a href="#" onclick="getElementById('submit').click();"><img src="$!images/action-ico-registra.png" />Salva</a></li>
<li><a 
#if($obj.Id)
href=".consegne?id=$obj.Id"><img src="$!images/action-ico-modifica.png" /> Dettaglio</a></li>
#else 
href=".consegne?cmd=list"><img src="$!images/action-ico-elimina.png" /> Annulla</a></li>
#end
##<li><a href=".consegne?cmd=edit"><img src="$!images/action-ico-nuovo.png" /> Nuova consegna</a></li>
</ul>
</div>

#set($im7=false)
#set($im4=false)
#if($obj.Iter.Regdoganale)
#set($im7=true)
#else
#set($im4=true)
#end
<div id="dlg_OpenC" class="flora" style="text-align:center;">
Inserire la data del carico in ingresso :
<form action=".consegne" id="openC">
<input type="hidden" name="cmd" value="apri" />
<input type="hidden" name="exec" value="1" />
<input type="hidden" name="id" value="" />
<input name="data" type="text" size="10" maxlength="10" id="dataOpenC" /><br />

<fieldset><legend>Valori</legend>
Valore USD: <input type="text" name="valoreDollari" size="10" id="valoreDollari" />&nbsp;$<br /> 
Tasso EUR/USD: <input type="text" name="tasso" size="5" id="tasso" /><br />
Oneri Accessori:&nbsp;&nbsp;<input type="text" name="valoreTestp" size="10" id="valoreTestp" />&nbsp;&euro;
</fieldset>

<fieldset><legend>Documento di Ingresso</legend>
Tipo: <select name="doc"><option value=""></option>
<option value="IM7" #if($im7)selected="selected"#end>IM7</option><option value="IM4"#if($im4) selected="selected"#end>IM4</option><option value="COM">COM</option></select>
Numero: <input type="text" name="doc_num" size="4" />
Data:  <input type="text" name="doc_data" id="doc_data" size="9" maxlength="10"/></fieldset>
<fieldset><legend>Documento di Ingresso (Portovesme)</legend>
Tipo: <select name="docPV"><option value=""></option><option value="IM7">IM7</option>
<option value="IM4">IM4</option><option value="COM">COM</option></select>
Numero: <input type="text" name="docPV_num" size="4"/>
Data:  <input type="text" id="docPV_data" name="docPV_data" size="9" maxlength="10" /></fieldset>
<br />
Note :<br />
<textarea name="note" cols="40" rows="4"></textarea>
</form>
</div>

#parse('footer.vm')